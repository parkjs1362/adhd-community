# v0.6.0 설계 문서: SEO 강화 + Web Push 알림

**작성일**: 2026-02-21
**현재 버전**: v0.5.0 → **목표**: v0.6.0
**배포 URL**: `adhd-community-gold.vercel.app`

---

## 목표

검색 유입 증가 + 재방문율 향상을 동시에 달성한다.

- **SEO 강화**: 구글이 게시글을 토론 콘텐츠로 인식하도록 구조화 데이터 추가
- **Web Push 알림**: 계정 없이 익명으로도 "내 글에 댓글 달림" 알림 수신

---

## 섹션 1: SEO 강화

### 문제

- 게시글 페이지에 JSON-LD 없음 → 구글 Rich Result 미노출
- `sitemap.xml`에 개별 게시글 없음 → 크롤링 누락 가능
- 메타 `description`이 사이트 전체 공통 → 검색 결과 CTR 저하

### 구현 내용

#### 1-1. JSON-LD 구조화 데이터

**게시글 페이지** (`post/[id]/page.tsx`):
```json
{
  "@context": "https://schema.org",
  "@type": "DiscussionForumPosting",
  "headline": "게시글 제목",
  "text": "본문 앞 200자",
  "datePublished": "ISO 날짜",
  "author": { "@type": "Person", "name": "닉네임" },
  "interactionStatistic": [
    { "@type": "InteractionCounter", "interactionType": "LikeAction", "userInteractionCount": 5 },
    { "@type": "InteractionCounter", "interactionType": "CommentAction", "userInteractionCount": 12 }
  ],
  "url": "https://adhd-community-gold.vercel.app/post/..."
}
```

**홈페이지** (`layout.tsx`):
```json
{
  "@type": "WebSite",
  "name": "ADHD 커뮤니티",
  "url": "https://adhd-community-gold.vercel.app",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://adhd-community-gold.vercel.app/search?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
```

**게시글/게시판 페이지** — BreadcrumbList:
```json
{
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "position": 1, "name": "홈", "item": "/" },
    { "position": 2, "name": "자유게시판", "item": "/board/free" },
    { "position": 3, "name": "게시글 제목", "item": "/post/..." }
  ]
}
```

#### 1-2. 게시글별 메타 태그

```typescript
// post/[id]/page.tsx
export async function generateMetadata({ params }) {
  const post = await getPost(params.id);
  return {
    title: `${post.title} | ADHD 커뮤니티`,
    description: post.content.slice(0, 120).replace(/\n/g, ' '),
    openGraph: {
      title: post.title,
      description: post.content.slice(0, 120),
      type: 'article',
      publishedTime: post.created_at,
    },
  };
}
```

#### 1-3. sitemap.xml 강화

현재: 게시판 5개만 포함
변경: 게시글 전체 포함 + `lastmod`, `changefreq`, `priority`

```typescript
// sitemap.ts
const posts = await getAllPostsForSitemap(); // id, updated_at 만 조회
return [
  ...boards.map(b => ({ url: `/board/${b.slug}`, changeFrequency: 'hourly', priority: 0.8 })),
  ...posts.map(p => ({ url: `/post/${p.id}`, lastModified: p.updated_at, changeFrequency: 'weekly', priority: 0.6 })),
];
```

### 수정 파일

| 파일 | 변경 내용 |
|------|----------|
| `src/app/post/[id]/page.tsx` | JSON-LD (DiscussionForumPosting + BreadcrumbList) + 메타 태그 |
| `src/app/layout.tsx` | JSON-LD (WebSite + SearchAction) |
| `src/app/board/[slug]/page.tsx` | BreadcrumbList JSON-LD |
| `src/app/sitemap.ts` | 게시글 전체 포함, lastmod/priority 추가 |
| `src/app/actions/posts.ts` | sitemap용 `getAllPostsForSitemap()` 추가 |

---

## 섹션 2: Web Push 알림

### 설계 원칙

- **계정 불필요**: `author_hash`(IP 해시)로 "내 글/댓글" 판별
- **구독 자발적**: 게시글 작성 완료 후 "댓글 알림 받기" 버튼 노출
- **서버 발송**: 새 댓글 저장 시 Server Action에서 Web Push API 호출

### 알림 트리거

| 이벤트 | 수신자 | 알림 내용 |
|--------|--------|----------|
| 내 게시글에 새 댓글 | 게시글 author_hash 구독자 | "○○님이 댓글을 남겼습니다: [내용 앞 30자]" |
| 내 댓글에 답글 | 댓글 author_hash 구독자 | "○○님이 답글을 남겼습니다: [내용 앞 30자]" |

### DB 변경

```sql
-- 신규 테이블
CREATE TABLE push_subscriptions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  author_hash TEXT NOT NULL,
  subscription JSONB NOT NULL,  -- PushSubscription 객체 전체
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(author_hash, (subscription->>'endpoint'))
);

CREATE INDEX idx_push_subscriptions_author ON push_subscriptions(author_hash);

-- RLS
ALTER TABLE push_subscriptions ENABLE ROW LEVEL SECURITY;
CREATE POLICY "push_insert" ON push_subscriptions FOR INSERT WITH CHECK (true);
CREATE POLICY "push_read_service_only" ON push_subscriptions FOR SELECT USING (false); -- service_role만 읽기
```

### 아키텍처

```
브라우저                    Next.js 서버              Supabase
   |                           |                        |
   | 게시글 작성 완료           |                        |
   |<-- "알림 받기" 버튼 표시   |                        |
   | Push 권한 허용             |                        |
   | --> /api/push/subscribe   |                        |
   |                           | --> push_subscriptions |
   |                           |     INSERT             |
   |                           |                        |
   | 다른 사용자 댓글 작성       |                        |
   |                           | createComment() 내부:  |
   |                           | 게시글 author_hash 조회|
   |                           | push_subscriptions 조회|
   |                           | Web Push API 호출      |
   |<-- Push 알림 수신 (sw.js) |                        |
```

### 신규/수정 파일

```
신규:
  public/sw.js                          — Service Worker (push 이벤트 처리, 알림 표시)
  src/app/api/push/subscribe/route.ts   — 구독 저장 POST API
  src/components/PushSubscribeButton.tsx — "알림 받기" 클라이언트 버튼

수정:
  src/app/actions/comments.ts           — createComment() 내 Push 발송 로직 추가
  src/app/post/[id]/page.tsx            — 게시글 작성 후 PushSubscribeButton 노출
```

### 환경변수

```bash
# VAPID 키 생성 (web-push 패키지 사용)
npx web-push generate-vapid-keys

VAPID_PUBLIC_KEY=...
VAPID_PRIVATE_KEY=...
VAPID_EMAIL=mailto:admin@adhd-community.com
NEXT_PUBLIC_VAPID_PUBLIC_KEY=...  # 브라우저에서 사용
```

### Service Worker 핵심 코드 (`public/sw.js`)

```javascript
self.addEventListener('push', (event) => {
  const data = event.data.json();
  event.waitUntil(
    self.registration.showNotification(data.title, {
      body: data.body,
      icon: '/icon-192.png',
      data: { url: data.url },
    })
  );
});

self.addEventListener('notificationclick', (event) => {
  event.notification.close();
  event.waitUntil(clients.openWindow(event.notification.data.url));
});
```

---

## 커밋 계획

```
feat: JSON-LD 구조화 데이터 추가 (DiscussionForumPosting, WebSite, BreadcrumbList)
feat: 게시글별 메타 description 동적 생성
feat: sitemap에 게시글 전체 포함 (lastmod, priority)
feat: Web Push 알림 기반 구축 (Service Worker, VAPID, push_subscriptions)
feat: 댓글 작성 시 게시글 작성자에게 Push 알림 발송
feat: 답글 작성 시 댓글 작성자에게 Push 알림 발송
chore: v0.6.0 bump
```

---

## 검증 체크리스트

- [ ] Google Rich Results Test 통과 (DiscussionForumPosting)
- [ ] sitemap.xml에 게시글 URL 포함 확인
- [ ] Push 알림 허용 → 다른 기기에서 댓글 작성 → 알림 수신
- [ ] 알림 클릭 → 해당 게시글 페이지로 이동
- [ ] Push 구독 취소 시 DB에서 삭제 처리
